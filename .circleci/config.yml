version: 2.1

executors:
  troubleshoot-executor:
    docker:
      - image: circleci/python:3.8
    working_directory: ~/project

jobs:
  analyze-support-bundle:
    executor: troubleshoot-executor
    steps:
      - checkout

      # Download, extract, and install the Troubleshoot CLI for Linux
      - run:
          name: Install Troubleshoot CLI
          command: |
            curl -LO https://github.com/replicatedhq/troubleshoot/releases/download/v0.114.0/collect_linux_amd64.tar.gz
            tar -xzf collect_linux_amd64.tar.gz
            chmod +x collect
            sudo mv collect /usr/local/bin/support-bundle

      # Verify the CLI installation
      - run:
          name: Verify Troubleshoot CLI
          command: |
            support-bundle --help

      # Prepare the Support Bundle
      - run:
          name: Prepare Support Bundle
          command: |
            mkdir -p support-bundle
            cp ./support-bundle-2.tar.gz support-bundle/

      # Debug Input File
      - run:
          name: Debug Input File
          command: |
            ls -l support-bundle/
            file support-bundle/support-bundle-2.tar.gz

      # Test Analyze Command without redirection
      - run:
          name: Test Analyze Command
          command: |
            support-bundle analyze support-bundle/support-bundle-2.tar.gz --output json

      # Analyze the Support Bundle with redirection
      - run:
          name: Analyze Support Bundle
          command: |
            mkdir -p analysis-output
            support-bundle analyze support-bundle/support-bundle-2.tar.gz --output json > analysis-output/results.json

      # Debug Analysis Output
      - run:
          name: Debug Analysis Output
          command: |
            ls -l analysis-output
            cat analysis-output/results.json || echo "No results.json file found"

      # Store analysis results as artifacts
      - store_artifacts:
          path: analysis-output
          destination: support-bundle-analysis

workflows:
  version: 2
  support-bundle-analysis:
    jobs:
      - analyze-support-bundle
